(()=>{"use strict";class e{sprite=5;getSteps(e,t,o,l){let s=[],i=(e?1:-1)+t;0===e&&6===t&&null===v.board[i-1][o]&&s.push({v:i-1,h:o,pawnPass:!1}),1===e&&1===t&&null===v.board[i+1][o]&&s.push({v:i+1,h:o,pawnPass:!1}),null===v.board[i][o]&&s.push({v:i,h:o,pawnPass:!1});for(let t of[-1,1]){let l=o+t;l<0||l>7||null!==v.board[i][l]&&v.board[i][l].color!==e&&s.push({v:i,h:l,pawnPass:!1})}return"pawn"==v.board[v.lastMove.to.v][v.lastMove.to.h].pieceName&&(3==v.lastMove.to.v&&1==v.lastMove.from.v&&0==e&&3==t&&(o-1==v.lastMove.to.h&&s.push({v:2,h:o-1,pawnPass:!0}),o+1==v.lastMove.to.h&&s.push({v:2,h:o+1,pawnPass:!0})),4==v.lastMove.to.v&&6==v.lastMove.from.v&&1==e&&4==t&&(o-1==v.lastMove.to.h&&s.push({v:5,h:o-1,pawnPass:!0}),o+1==v.lastMove.to.h&&s.push({v:5,h:o+1,pawnPass:!0}))),s}}class t{sprite=3;getSteps(e,t,o,l){let s=[],i=[{h:2,v:1,a:!0},{h:2,v:-1,a:!0},{h:-2,v:1,a:!0},{h:-2,v:-1,a:!0},{h:1,v:2,a:!0},{h:1,v:-2,a:!0},{h:-1,v:2,a:!0},{h:-1,v:-2,a:!0}];for(let l=1;l<2;l++)for(let n=0;n<8;n++){let a=i[n];if(a.a){let i=o+a.h*l,n=t+a.v*l;if(i>7||i<0)continue;if(n>7||n<0)continue;if(null===v.board[n][i])s.push({v:n,h:i,pawnPass:!1});else{if(void 0===v.board[n][i])continue;v.board[n][i].color!==e&&s.push({v:n,h:i,pawnPass:!1}),a.a=!1}}}return s}}class o{sprite=0;getSteps(e,t,o,l){let s=[],i=[{h:1,v:1,a:!0},{h:-1,v:-1,a:!0},{h:1,v:-1,a:!0},{h:-1,v:1,a:!0},{h:1,v:0,a:!0},{h:-1,v:0,a:!0},{h:0,v:1,a:!0},{h:0,v:-1,a:!0}];for(let l=1;l<2;l++)for(let n=0;n<8;n++){let a=i[n];if(a.a){let i=o+a.h*l,n=t+a.v*l;if(i>7||i<0)continue;if(n>7||n<0)continue;if(null===v.board[n][i])s.push({v:n,h:i,pawnPass:!1});else{if(void 0===v.board[n][i])continue;v.board[n][i].color!==e&&s.push({v:n,h:i,pawnPass:!1}),a.a=!1}}}if(!l&&!v.board[t][o].moved){if(null!=v.board[t][0]&&"rook"==v.board[t][0].pieceName&&!v.board[t][0].moved){let e=!1;for(let l=o-1;l>0;l--)null!==v.board[t][l]&&(e=!0);e||s.push({v:t,h:o-2,pawnPass:!1})}if(null!=v.board[t][7]&&"rook"==v.board[t][7].pieceName&&!v.board[t][7].moved){let e=!1;for(let l=o+1;l<7;l++)null!==v.board[t][l]&&(e=!0);e||s.push({v:t,h:o+2,pawnPass:!1})}}return s}}class l{sprite=1;getSteps(e,t,o,l){let s=[],i=[{h:1,v:1,a:!0},{h:-1,v:-1,a:!0},{h:1,v:-1,a:!0},{h:-1,v:1,a:!0},{h:1,v:0,a:!0},{h:-1,v:0,a:!0},{h:0,v:1,a:!0},{h:0,v:-1,a:!0}];for(let l=1;l<8;l++)for(let n=0;n<8;n++){let a=i[n];if(a.a){let i=o+a.h*l,n=t+a.v*l;if(i>7||i<0)continue;if(n>7||n<0)continue;if(null===v.board[n][i])s.push({v:n,h:i,pawnPass:!1});else{if(void 0===v.board[n][i])continue;v.board[n][i].color!==e&&s.push({v:n,h:i,pawnPass:!1}),a.a=!1}}}return s}}class s{sprite=2;getSteps(e,t,o,l){let s=[],i=[{h:1,v:1,a:!0},{h:-1,v:-1,a:!0},{h:1,v:-1,a:!0},{h:-1,v:1,a:!0}];for(let l=1;l<8;l++)for(let n=0;n<4;n++){let a=i[n];if(a.a){let i=o+a.h*l,n=t+a.v*l;if(i>7||i<0)continue;if(n>7||n<0)continue;if(null===v.board[n][i])s.push({v:n,h:i,pawnPass:!1});else{if(void 0===v.board[n][i])continue;v.board[n][i].color!==e&&s.push({v:n,h:i,pawnPass:!1}),a.a=!1}}}return s}}class i{sprite=4;getSteps(e,t,o,l){let s=[],i=[{h:1,v:0,a:!0},{h:-1,v:0,a:!0},{h:0,v:-1,a:!0},{h:0,v:1,a:!0}];for(let l=1;l<8;l++)for(let n=0;n<4;n++){let a=i[n];if(a.a){let i=o+a.h*l,n=t+a.v*l;if(i>7||i<0)continue;if(n>7||n<0)continue;if(null===v.board[n][i])s.push({v:n,h:i,pawnPass:!1});else{if(void 0===v.board[n][i])continue;v.board[n][i].color!==e&&s.push({v:n,h:i,pawnPass:!1}),a.a=!1}}}return s}}class n{color=0;v=0;h=0;piece=null;pieceName="";active=!1;moved=!1;constructor(n,a,h,c){switch(this.h=a,this.v=h,this.color=c,this.pieceName=n,n){case"pawn":this.piece=new e;break;case"knight":this.piece=new t;break;case"king":this.piece=new o;break;case"queen":this.piece=new l;break;case"bishop":this.piece=new s;break;case"rook":this.piece=new i;break;default:console.error("Didn't find piece")}}sprite(){return this.piece.sprite}setActive(){this.active=!0}setDisactive(){this.active=!1}getSteps(e){return this.piece.getSteps(this.color,this.v,this.h,e)}go(e,t){v.board[this.v][this.h]=null,this.h=e,this.v=t,v.board[t][e]=this}}const a={sprites:{chessmen:null},init(){this.sprites.chessmen=new Image,this.sprites.chessmen.src="sprites.png"}},h={canvas:null,ctx:null,colors:{board:{black:"#ceb29c",white:"#f5e6cf",active:"#9cce9d",tip:"#9cc0ce"}},isPhone:!1,init(){this.canvas=document.getElementById("canvas"),this.ctx=this.canvas.getContext("2d"),/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(this.isPhone=!0)},draw(e,t,o,l,s){this.board(e),this.tips(e,s,l),this.chessmen(e,t,o)},board(e){this.ctx.fillStyle="rgb(255, 255, 255)",this.ctx.fillRect(0,0,8*e,8*e);let t=0;for(let o=0;o<8;o++){for(let l=0;l<8;l++)this.ctx.fillStyle=t%2==-0?this.colors.board.black:this.colors.board.white,this.ctx.fillRect(l*e,o*e,e,e),t++;t++}},chessmen(e,t,o){for(let l=0;l<8;l++)for(let s=0;s<8;s++)null!==t[l][s]&&this.piece(t[l][s],e,o)},piece(e,t,o){e.active?(this.ctx.fillStyle=this.colors.board.active,this.ctx.fillRect(e.h*t,e.v*t,t,t),this.isPhone?this.ctx.drawImage(a.sprites.chessmen,213*e.sprite(),213*e.color,213,213,e.h*t,e.v*t,t,t):this.ctx.drawImage(a.sprites.chessmen,213*e.sprite(),213*e.color,213,213,o.x-v.block/2,o.y-v.block/2,t,t)):this.ctx.drawImage(a.sprites.chessmen,213*e.sprite(),213*e.color,213,213,e.h*t,e.v*t,t,t)},tips(e,t,o){if(null!==o)for(let o=0;o<t.length;o++)this.ctx.fillStyle=this.colors.board.tip,this.ctx.globalAlpha=.7,this.ctx.fillRect(t[o].h*e,t[o].v*e,e,e),this.ctx.globalAlpha=1}},c={join(e){document.getElementById("join").style.display=e?"block":"none"},wait(e){document.getElementById("wait").style.display=e?"block":"none"},cursor(e){document.body.style.cursor=e},resize(){let e=.75*Math.min(window.innerWidth,window.innerHeight);h.canvas.width=e,h.canvas.height=e,v.block=e/8},showChoose(e){document.getElementById("choose").style.display=e?"block":"none"},choosePiece(e){this.showChoose(!1),v.move(v.moveBeforeChoose.v,v.moveBeforeChoose.h,e)}},r={create(e){p.createRoom(e),c.join(!1),c.wait(!0)},join(e){p.joinRoom(e),c.join(!1),c.wait(!0)}},u={cursor:{x:0,y:0,ox:0,oy:0},init(){document.getElementById("createRoom").addEventListener("click",(e=>{r.create(document.getElementById("roomName").value)})),document.getElementById("joinRoom").addEventListener("click",(e=>{r.join(document.getElementById("roomName").value)})),v.isPhone?(h.canvas.addEventListener("touchstart",(e=>{console.log("touchstart"),console.log(e);let t=e.target.getBoundingClientRect(),o={offsetX:e.touches[0].clientX-t.x,offsetY:e.touches[0].clientY-t.y};this.down(o)})),h.canvas.addEventListener("touchend",(e=>{e.changedTouches[0].clientX,e.changedTouches[0].clientY})),h.canvas.addEventListener("touchmove",(e=>{console.log("touchmove");let t=e.target.getBoundingClientRect(),o={offsetX:e.touches[0].clientX-t.x,offsetY:e.touches[0].clientY-t.y};this.move(o)}))):(h.canvas.addEventListener("mousedown",(e=>{console.log("mousedown"),console.log(e),this.down(e)})),h.canvas.addEventListener("mouseup",(e=>{console.log("mouseup"),this.up(e)})),h.canvas.addEventListener("mousemove",(e=>{console.log("mousemove"),this.move(e)}))),document.getElementById("choose_queen").addEventListener("click",(e=>{c.choosePiece("queen")})),document.getElementById("choose_bishop").addEventListener("click",(e=>{c.choosePiece("bishop")})),document.getElementById("choose_knight").addEventListener("click",(e=>{c.choosePiece("knight")})),document.getElementById("choose_rook").addEventListener("click",(e=>{c.choosePiece("rook")})),window.addEventListener("resize",(e=>{c.resize()}))},down(e){let t=Math.floor(e.offsetX/v.block),o=Math.floor(e.offsetY/v.block);this.cursor.ox=t*v.block-e.offsetX,this.cursor.oy=o*v.block-e.offsetY,console.log({x:e.offsetX,y:e.offsetY}),v.isPhone?v.selectPhone(o,t):v.select(o,t)},up(e){let t=Math.floor(e.offsetX/v.block),o=Math.floor(e.offsetY/v.block);v.move(o,t)},move(e){this.cursor.x=e.offsetX,this.cursor.y=e.offsetY}},v={active:null,block:100,size:1,tips:[],board:[[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null]],start_positions:[[["rook",1],["knight",1],["bishop",1],["queen",1],["king",1],["bishop",1],["knight",1],["rook",1]],[["pawn",1],["pawn",1],["pawn",1],["pawn",1],["pawn",1],["pawn",1],["pawn",1],["pawn",1]],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[["pawn",0],["pawn",0],["pawn",0],["pawn",0],["pawn",0],["pawn",0],["pawn",0],["pawn",0]],[["rook",0],["knight",0],["bishop",0],["queen",0],["king",0],["bishop",0],["knight",0],["rook",0]]],color:null,canMove:!1,moveBeforeChoose:{h:0,v:0},lastMove:{from:{v:0,h:0},to:{v:0,h:0}},isPhone:!1,init(){/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(this.isPhone=!0),console.log({isPhone:this.isPhone});for(let e=0;e<8;e++)for(let t=0;t<8;t++)null!==this.start_positions[e][t]&&(this.board[e][t]=new n(this.start_positions[e][t][0],t,e,this.start_positions[e][t][1]));this.tic()},tic(){h.draw(this.block,this.board,u.cursor,this.active,this.tips)},select(e,t){if(this.canMove&&null!==this.board[e][t]){if(console.log(this.board[e][t]),this.board[e][t].color!==this.color)return;this.board[e][t].setActive();let o=this.isCheck(this.color);this.tips=this.board[e][t].getSteps(o),this.active={v:e,h:t},c.cursor("grabbing")}},selectPhone(e,t){if(this.canMove)if(null!==this.board[e][t])if(this.board[e][t].color===this.color){this.board[e][t].setActive();let o=this.isCheck(this.color);this.tips=this.board[e][t].getSteps(o),this.active={v:e,h:t}}else this.move(e,t);else this.move(e,t)},move(e,t,o=""){if(this.active){if(null!==this.board[this.active.v][this.active.h]){let l=this.isCheck(this.color),s=this.board[this.active.v][this.active.h].getSteps(l),i=!1,a=!1;for(let o of s)o.h===t&&o.v===e&&(i=!0,a=o.pawnPass);if(i){if(""==o&&"pawn"==this.board[this.active.v][this.active.h].pieceName&&(0==e||7==e))return this.moveBeforeChoose={v:e,h:t},void c.showChoose(!0);let l=this.board[e][t];this.board[this.active.v][this.active.h].go(t,e);let s=!1,i=!1;if("king"==this.board[e][t].pieceName&&Math.abs(t-this.active.h)>1&&(t>this.active.h?this.board[this.active.v][7].go(t-1,e):(this.board[this.active.v][0].go(t+1,e),i=!0),s=!0),this.isCheck(this.color))this.board[e][t].go(this.active.h,this.active.v),this.board[e][t]=l,s&&(i?this.board[e][t+1].go(0,this.active.v):this.board[e][t-1].go(7,this.active.v));else{let l={h:this.active.h,v:this.active.v},s={h:t,v:e};if(p.move(l,s,o),this.lastMove={from:l,to:s},this.canMove=!1,this.active={v:e,h:t},this.board[e][t].moved=!0,""!=o&&(this.board[s.v][s.h]=new n(o,t,e,this.color)),a){let e=this.color?-1:1;this.board[s.v+e][s.h]=null}}}}this.board[this.active.v][this.active.h].setDisactive(),this.active=null}c.cursor("default")},isCheck(e){let t=null;for(let o=0;o<8;o++)for(let l=0;l<8;l++)null!==this.board[o][l]&&"king"===this.board[o][l].pieceName&&this.board[o][l].color===e&&(t={v:o,h:l});for(let o=0;o<8;o++)for(let l=0;l<7;l++)if(null!==this.board[o][l]){let s=this.board[o][l];if(s.color!==e){let e=s.getSteps(!1);for(let o=0;o<e.length;o++)if(e[o].h===t.h&&e[o].v===t.v)return!0}}return!1}},d={run(e){switch(console.log(e),e.action){case"move":this.move(e.move.from,e.move.to,e.move.selectPiece);break;case"start":this.start(e.start_game.color);break;case"end":this.end(e.end);break;default:console.error("Event didnt find")}},start(e){c.wait(!1),v.color=e,v.canMove=0==e},end(e){1==e&&window.alert("You won"),2==e&&window.alert("Draw"),3==e&&window.alert("You lose")},move(e,t,o){v.board[e.v][e.h].go(t.h,t.v),v.canMove=!0,"king"==v.board[t.v][t.h].pieceName&&Math.abs(t.h-e.h)>1&&(t.h>e.h?v.board[e.v][7].go(t.h-1,t.v):v.board[e.v][0].go(t.h+1,t.v)),"pawn"==v.board[t.v][t.h].pieceName&&(""!=o&&(0!=t.v&&7!=t.v||(v.board[t.v][t.h]=new n(o,t.h,t.v,v.color?0:1))),"pawn"==v.board[v.lastMove.to.v][v.lastMove.to.h].pieceName&&2==Math.abs(v.lastMove.to.v-v.lastMove.from.v)&&v.lastMove.to.h==t.h&&(v.color?2==t.v&&(v.board[v.lastMove.to.v][v.lastMove.to.h]=null):5==t.v&&(v.board[v.lastMove.to.v][v.lastMove.to.h]=null))),v.lastMove={from:e,to:t}}},p={conn:null,init(){let e=window.location.host;this.conn=new WebSocket("ws://"+e+"/ws"),this.conn.onclose=function(e){console.warn("Connection closed")},this.conn.onopen=function(e){console.log("Socket connected")},this.conn.onmessage=function(e){let t=JSON.parse(e.data);console.log(e.data),d.run(t)}},joinRoom(e){this.send("join_room",{create_room:{room_name:e}})},createRoom(e){this.send("create_room",{join_room:{room_name:e}})},move(e,t,o){this.send("move",{move:{from:e,to:t,selectPiece:o}})},changePawn(e){this.send("change_pawn",{"":{name:e}})},send(e,t){let o={action:e,...t},l=JSON.stringify(o);this.conn.send(l)}};a.init(),h.init(),v.init(),u.init(),p.init(),c.resize(),setInterval((()=>{v.tic()}),100)})();