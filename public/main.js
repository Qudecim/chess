(()=>{"use strict";class t{sprite=5;getSteps(t,e,l,o){let i=[],n=(t?1:-1)+e;0===t&&6===e&&null===v.board[n-1][l]&&i.push({v:n-1,h:l}),1===t&&1===e&&null===v.board[n+1][l]&&i.push({v:n+1,h:l}),null===v.board[n][l]&&i.push({v:n,h:l});for(let e of[-1,1]){let o=l+e;o<0||o>7||null!==v.board[n][o]&&v.board[n][o].color!==t&&i.push({v:n,h:o})}return i}}class e{sprite=3;getSteps(t,e,l,o){let i=[],n=[{h:2,v:1,a:!0},{h:2,v:-1,a:!0},{h:-2,v:1,a:!0},{h:-2,v:-1,a:!0},{h:1,v:2,a:!0},{h:1,v:-2,a:!0},{h:-1,v:2,a:!0},{h:-1,v:-2,a:!0}];for(let o=1;o<2;o++)for(let s=0;s<8;s++){let a=n[s];if(a.a){let n=l+a.h*o,s=e+a.v*o;if(n>7||n<0)continue;if(s>7||s<0)continue;if(null===v.board[s][n])i.push({v:s,h:n});else{if(void 0===v.board[s][n])continue;v.board[s][n].color!==t&&i.push({v:s,h:n}),a.a=!1}}}return i}}class l{sprite=0;getSteps(t,e,l,o){let i=[],n=[{h:1,v:1,a:!0},{h:-1,v:-1,a:!0},{h:1,v:-1,a:!0},{h:-1,v:1,a:!0},{h:1,v:0,a:!0},{h:-1,v:0,a:!0},{h:0,v:1,a:!0},{h:0,v:-1,a:!0}];for(let o=1;o<2;o++)for(let s=0;s<8;s++){let a=n[s];if(a.a){let n=l+a.h*o,s=e+a.v*o;if(n>7||n<0)continue;if(s>7||s<0)continue;if(null===v.board[s][n])i.push({v:s,h:n});else{if(void 0===v.board[s][n])continue;v.board[s][n].color!==t&&i.push({v:s,h:n}),a.a=!1}}}if(!o&&!v.board[e][l].moved){if(null!=v.board[e][0]&&"rook"==v.board[e][0].pieceName&&!v.board[e][0].moved){let t=!1;for(let o=l-1;o>0;o--)null!==v.board[e][o]&&(t=!0);t||i.push({v:e,h:l-2})}if(null!=v.board[e][7]&&"rook"==v.board[e][7].pieceName&&!v.board[e][7].moved){let t=!1;for(let o=l+1;o<7;o++)null!==v.board[e][o]&&(t=!0);t||i.push({v:e,h:l+2})}}return i}}class o{sprite=1;getSteps(t,e,l,o){let i=[],n=[{h:1,v:1,a:!0},{h:-1,v:-1,a:!0},{h:1,v:-1,a:!0},{h:-1,v:1,a:!0},{h:1,v:0,a:!0},{h:-1,v:0,a:!0},{h:0,v:1,a:!0},{h:0,v:-1,a:!0}];for(let o=1;o<8;o++)for(let s=0;s<8;s++){let a=n[s];if(a.a){let n=l+a.h*o,s=e+a.v*o;if(n>7||n<0)continue;if(s>7||s<0)continue;if(null===v.board[s][n])i.push({v:s,h:n});else{if(void 0===v.board[s][n])continue;v.board[s][n].color!==t&&i.push({v:s,h:n}),a.a=!1}}}return i}}class i{sprite=2;getSteps(t,e,l,o){let i=[],n=[{h:1,v:1,a:!0},{h:-1,v:-1,a:!0},{h:1,v:-1,a:!0},{h:-1,v:1,a:!0}];for(let o=1;o<8;o++)for(let s=0;s<4;s++){let a=n[s];if(a.a){let n=l+a.h*o,s=e+a.v*o;if(n>7||n<0)continue;if(s>7||s<0)continue;if(null===v.board[s][n])i.push({v:s,h:n});else{if(void 0===v.board[s][n])continue;v.board[s][n].color!==t&&i.push({v:s,h:n}),a.a=!1}}}return i}}class n{sprite=4;getSteps(t,e,l,o){let i=[],n=[{h:1,v:0,a:!0},{h:-1,v:0,a:!0},{h:0,v:-1,a:!0},{h:0,v:1,a:!0}];for(let o=1;o<8;o++)for(let s=0;s<4;s++){let a=n[s];if(a.a){let n=l+a.h*o,s=e+a.v*o;if(n>7||n<0)continue;if(s>7||s<0)continue;if(null===v.board[s][n])i.push({v:s,h:n});else{if(void 0===v.board[s][n])continue;v.board[s][n].color!==t&&i.push({v:s,h:n}),a.a=!1}}}return i}}class s{color=0;v=0;h=0;piece=null;pieceName="";active=!1;moved=!1;constructor(s,a,h,r){switch(this.h=a,this.v=h,this.color=r,this.pieceName=s,s){case"pawn":this.piece=new t;break;case"knight":this.piece=new e;break;case"king":this.piece=new l;break;case"queen":this.piece=new o;break;case"bishop":this.piece=new i;break;case"rook":this.piece=new n;break;default:console.error("Didn't find piece")}}sprite(){return this.piece.sprite}setActive(){this.active=!0}setDisactive(){this.active=!1}getSteps(t){return this.piece.getSteps(this.color,this.v,this.h,t)}go(t,e){v.board[this.v][this.h]=null,this.h=t,this.v=e,v.board[e][t]=this}}const a={sprites:{chessmen:null},init(){this.sprites.chessmen=new Image,this.sprites.chessmen.src="sprites.png"}},h={canvas:null,ctx:null,colors:{board:{black:"#ceb29c",white:"#f5e6cf",active:"#9cce9d",tip:"#9cc0ce"}},init(){this.canvas=document.getElementById("canvas"),this.ctx=this.canvas.getContext("2d")},draw(t,e,l,o,i){this.board(t),this.tips(t,i,o),this.chessmen(t,e,l)},board(t){this.ctx.fillStyle="rgb(255, 255, 255)",this.ctx.fillRect(0,0,8*t,8*t);let e=0;for(let l=0;l<8;l++){for(let o=0;o<8;o++)this.ctx.fillStyle=e%2==-0?this.colors.board.black:this.colors.board.white,this.ctx.fillRect(o*t,l*t,t,t),e++;e++}},chessmen(t,e,l){for(let o=0;o<8;o++)for(let i=0;i<8;i++)null!==e[o][i]&&this.piece(e[o][i],t,l)},piece(t,e,l){t.active?(this.ctx.fillStyle=this.colors.board.active,this.ctx.fillRect(t.h*e,t.v*e,e,e),this.ctx.drawImage(a.sprites.chessmen,213*t.sprite(),213*t.color,213,213,l.x-v.block/2,l.y-v.block/2,e,e)):this.ctx.drawImage(a.sprites.chessmen,213*t.sprite(),213*t.color,213,213,t.h*e,t.v*e,e,e)},tips(t,e,l){if(null!==l)for(let l=0;l<e.length;l++)this.ctx.fillStyle=this.colors.board.tip,this.ctx.globalAlpha=.7,this.ctx.fillRect(e[l].h*t,e[l].v*t,t,t),this.ctx.globalAlpha=1}},r={join(t){document.getElementById("join").style.display=t?"block":"none"},wait(t){document.getElementById("wait").style.display=t?"block":"none"},cursor(t){document.body.style.cursor=t},resize(){let t=.75*Math.min(window.innerWidth,window.innerHeight);h.canvas.width=t,h.canvas.height=t,v.block=t/8}},c={create(t){b.createRoom(t),r.join(!1),r.wait(!0)},join(t){b.joinRoom(t),r.join(!1),r.wait(!0)}},u={cursor:{x:0,y:0,ox:0,oy:0},init(){document.getElementById("createRoom").addEventListener("click",(t=>{c.create(document.getElementById("roomName").value)})),document.getElementById("joinRoom").addEventListener("click",(t=>{c.join(document.getElementById("roomName").value)})),h.canvas.addEventListener("mousedown",(t=>{this.down(t)})),h.canvas.addEventListener("mouseup",(t=>{this.up(t)})),h.canvas.addEventListener("mousemove",(t=>{this.move(t)})),window.addEventListener("resize",(t=>{r.resize()}))},down(t){let e=Math.floor(t.offsetX/v.block),l=Math.floor(t.offsetY/v.block);this.cursor.ox=e*v.block-t.offsetX,this.cursor.oy=l*v.block-t.offsetY,v.select(l,e)},up(t){let e=Math.floor(t.offsetX/v.block),l=Math.floor(t.offsetY/v.block);v.move(l,e)},move(t){this.cursor.x=t.offsetX,this.cursor.y=t.offsetY}},v={active:null,block:100,size:1,tips:[],board:[[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null]],start_positions:[[["rook",1],["knight",1],["bishop",1],["queen",1],["king",1],["bishop",1],["knight",1],["rook",1]],[["pawn",1],["pawn",1],["pawn",1],["pawn",1],["pawn",1],["pawn",1],["pawn",1],["pawn",1]],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[["pawn",0],["pawn",0],["pawn",0],["pawn",0],["pawn",0],["pawn",0],["pawn",0],["pawn",0]],[["rook",0],["knight",0],["bishop",0],["queen",0],["king",0],["bishop",0],["knight",0],["rook",0]]],color:null,canMove:!1,init(){for(let t=0;t<8;t++)for(let e=0;e<8;e++)null!==this.start_positions[t][e]&&(this.board[t][e]=new s(this.start_positions[t][e][0],e,t,this.start_positions[t][e][1]));this.tic()},tic(){h.draw(this.block,this.board,u.cursor,this.active,this.tips)},select(t,e){if(this.canMove&&null!==this.board[t][e]){if(console.log(this.board[t][e]),this.board[t][e].color!==this.color)return;this.board[t][e].setActive();let l=this.isCheck(this.color);this.tips=this.board[t][e].getSteps(l),this.active={v:t,h:e},r.cursor("grabbing")}},move(t,e){if(this.active){if(null!==this.board[this.active.v][this.active.h]){let l=this.isCheck(this.color),o=this.board[this.active.v][this.active.h].getSteps(l),i=!1;for(let l of o)l.h===e&&l.v===t&&(i=!0);if(i){let l=this.board[t][e];this.board[this.active.v][this.active.h].go(e,t);let o=!1,i=!1;if("king"==this.board[t][e].pieceName&&Math.abs(e-this.active.h)>1&&(e>this.active.h?this.board[this.active.v][7].go(e-1,t):(this.board[this.active.v][0].go(e+1,t),i=!0),o=!0),this.isCheck(this.color))this.board[t][e].go(this.active.h,this.active.v),this.board[t][e]=l,o&&(i?this.board[t][e+1].go(0,this.active.v):this.board[t][e-1].go(7,this.active.v));else{let l={h:this.active.h,v:this.active.v},i={h:e,v:t};b.move(l,i,o),this.canMove=!1,this.active={v:t,h:e},this.board[t][e].moved=!0}}}this.board[this.active.v][this.active.h].setDisactive(),this.active=null}r.cursor("default")},isCheck(t){let e=null;for(let l=0;l<8;l++)for(let o=0;o<8;o++)null!==this.board[l][o]&&"king"===this.board[l][o].pieceName&&this.board[l][o].color===t&&(e={v:l,h:o});for(let l=0;l<8;l++)for(let o=0;o<7;o++)if(null!==this.board[l][o]){let i=this.board[l][o];if(i.color!==t){let t=i.getSteps(!1);for(let l=0;l<t.length;l++)if(t[l].h===e.h&&t[l].v===e.v)return!0}}return!1}},d={run(t){switch(console.log(t),t.action){case"move":this.move(t.move.from,t.move.to);break;case"start":this.start(t.start_game.color);break;case"end":this.end(t.end);break;default:console.error("Event didnt find")}},start(t){r.wait(!1),v.color=t,v.canMove=0==t},end(t){1==t&&window.alert("You won"),2==t&&window.alert("Draw"),3==t&&window.alert("You lose")},move(t,e){v.board[t.v][t.h].go(e.h,e.v),v.canMove=!0,"king"==v.board[e.v][e.h].pieceName&&Math.abs(e.h-t.h)>1&&(e.h>t.h?v.board[t.v][7].go(e.h-1,e.v):v.board[t.v][0].go(e.h+1,e.v))}},b={conn:null,init(){this.conn=new WebSocket("ws://localhost/ws"),this.conn.onclose=function(t){console.warn("Connection closed")},this.conn.onopen=function(t){console.log("Socket connected")},this.conn.onmessage=function(t){let e=JSON.parse(t.data);console.log(t.data),d.run(e)}},joinRoom(t){this.send("join_room",{create_room:{room_name:t}})},createRoom(t){this.send("create_room",{join_room:{room_name:t}})},move(t,e,l){this.send("move",{move:{from:t,to:e,isCastling:l}})},send(t,e){let l={action:t,...e},o=JSON.stringify(l);this.conn.send(o)}};a.init(),h.init(),v.init(),u.init(),b.init(),r.resize(),setInterval((()=>{v.tic()}),100)})();