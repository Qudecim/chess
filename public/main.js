(()=>{"use strict";const l={create(l){console.log("create room: "+l),v.createRoom(l),document.getElementById("join").style.display="none",document.getElementById("wait").style.display="block"},join(l){console.log("join room: "+l),v.joinRoom(l),document.getElementById("join").style.display="none",document.getElementById("wait").style.display="block"}},t={start(){document.getElementById("createRoom").addEventListener("click",(t=>{l.create(document.getElementById("roomName").value)})),document.getElementById("joinRoom").addEventListener("click",(t=>{l.join(document.getElementById("roomName").value)})),u.canvas.addEventListener("mousedown",this.down),u.canvas.addEventListener("mouseup",this.up),u.canvas.addEventListener("mousemove",this.move)},down(l){let t=Math.floor(l.offsetX/u.block),e=Math.floor(l.offsetY/u.block);u.cursor.ox=t*u.block-l.offsetX,u.cursor.oy=e*u.block-l.offsetY,console.log([t,e]),u.select(e,t)},up(l){let t=Math.floor(l.offsetX/u.block),e=Math.floor(l.offsetY/u.block);console.log([t,e]),u.move(e,t)},move(l){u.cursor.x=l.offsetX,u.cursor.y=l.offsetY}};class e{draw(){return{sprite:5}}getSteps(l,t,e){let n=[],o=(l?1:-1)+t;0===l&&6===t&&null===u.board[o-1][e]&&n.push({v:o-1,h:e}),1===l&&1===t&&null===u.board[o+1][e]&&n.push({v:o+1,h:e}),null===u.board[o][e]&&n.push({v:o,h:e});for(let t of[-1,1]){let s=e+t;s<0||s>7||null!==u.board[o][s]&&u.board[o][s].color!==l&&n.push({v:o,h:s})}return n}}class n{draw(){return{sprite:3}}getSteps(l,t,e){let n=[],o=[{h:2,v:1,a:!0},{h:2,v:-1,a:!0},{h:-2,v:1,a:!0},{h:-2,v:-1,a:!0},{h:1,v:2,a:!0},{h:1,v:-2,a:!0},{h:-1,v:2,a:!0},{h:-1,v:-2,a:!0}];for(let s=1;s<2;s++)for(let i=0;i<8;i++){let a=o[i];if(a.a){let o=e+a.h*s,i=t+a.v*s;if(o>7||o<0)continue;if(i>7||i<0)continue;if(null===u.board[i][o])n.push({v:i,h:o});else{if(void 0===u.board[i][o])continue;u.board[i][o].color!==l&&n.push({v:i,h:o}),a.a=!1}}}return n}}class o{draw(){return{sprite:0}}getSteps(l,t,e){let n=[],o=[{h:1,v:1,a:!0},{h:-1,v:-1,a:!0},{h:1,v:-1,a:!0},{h:-1,v:1,a:!0},{h:1,v:0,a:!0},{h:-1,v:0,a:!0},{h:0,v:1,a:!0},{h:0,v:-1,a:!0}];for(let s=1;s<2;s++)for(let i=0;i<8;i++){let a=o[i];if(a.a){let o=e+a.h*s,i=t+a.v*s;if(o>7||o<0)continue;if(i>7||i<0)continue;if(null===u.board[i][o])n.push({v:i,h:o});else{if(void 0===u.board[i][o])continue;u.board[i][o].color!==l&&n.push({v:i,h:o}),a.a=!1}}}return n}}class s{draw(){return{sprite:1}}getSteps(l,t,e){let n=[],o=[{h:1,v:1,a:!0},{h:-1,v:-1,a:!0},{h:1,v:-1,a:!0},{h:-1,v:1,a:!0},{h:1,v:0,a:!0},{h:-1,v:0,a:!0},{h:0,v:1,a:!0},{h:0,v:-1,a:!0}];for(let s=1;s<8;s++)for(let i=0;i<8;i++){let a=o[i];if(a.a){let o=e+a.h*s,i=t+a.v*s;if(o>7||o<0)continue;if(i>7||i<0)continue;if(null===u.board[i][o])n.push({v:i,h:o});else{if(void 0===u.board[i][o])continue;u.board[i][o].color!==l&&n.push({v:i,h:o}),a.a=!1}}}return n}}class i{draw(){return{sprite:2}}getSteps(l,t,e){let n=[],o=[{h:1,v:1,a:!0},{h:-1,v:-1,a:!0},{h:1,v:-1,a:!0},{h:-1,v:1,a:!0}];for(let s=1;s<8;s++)for(let i=0;i<4;i++){let a=o[i];if(a.a){let o=e+a.h*s,i=t+a.v*s;if(o>7||o<0)continue;if(i>7||i<0)continue;if(null===u.board[i][o])n.push({v:i,h:o});else{if(void 0===u.board[i][o])continue;u.board[i][o].color!==l&&n.push({v:i,h:o}),a.a=!1}}}return n}}class a{draw(){return{sprite:4}}getSteps(l,t,e){let n=[],o=[{h:1,v:0,a:!0},{h:-1,v:0,a:!0},{h:0,v:-1,a:!0},{h:0,v:1,a:!0}];for(let s=1;s<8;s++)for(let i=0;i<4;i++){let a=o[i];if(a.a){let o=e+a.h*s,i=t+a.v*s;if(o>7||o<0)continue;if(i>7||i<0)continue;if(null===u.board[i][o])n.push({v:i,h:o});else{if(void 0===u.board[i][o])continue;u.board[i][o].color!==l&&n.push({v:i,h:o}),a.a=!1}}}return n}}const c={sprites:{chessmen:null},start(){this.sprites.chessmen=new Image,this.sprites.chessmen.src="sprites.png"}};class r{color=0;v=0;h=0;piece=null;active=!1;constructor(l,t,c,r){switch(this.h=t,this.v=c,this.color=r,l){case"pawn":this.piece=new e;break;case"knight":this.piece=new n;break;case"king":this.piece=new o;break;case"queen":this.piece=new s;break;case"bishop":this.piece=new i;break;case"rook":this.piece=new a;break;default:console.error("Didn't find piece")}}draw(){let l=this.piece.draw();this.active?(u.ctx.fillStyle="#9cce9d",u.ctx.fillRect(this.h*u.block,this.v*u.block,u.block,u.block),u.ctx.drawImage(c.sprites.chessmen,213*l.sprite,213*this.color,213,213,u.cursor.x+u.cursor.ox,u.cursor.y+u.cursor.oy,u.block,u.block)):u.ctx.drawImage(c.sprites.chessmen,213*l.sprite,213*this.color,213,213,this.h*u.block,this.v*u.block,u.block,u.block)}setActive(){this.active=!0,console.log("t3")}setDisactive(){this.active=!1}getSteps(){return this.piece.getSteps(this.color,this.v,this.h)}go(l,t){u.board[this.v][this.h]=null,this.h=l,this.v=t,u.board[t][l]=this}drawTips(){let l=this.getSteps();for(let t=0;t<l.length;t++)u.ctx.fillStyle="#9cc0ce",u.ctx.globalAlpha=.7,u.ctx.fillRect(l[t].h*u.block,l[t].v*u.block,u.block,u.block),u.ctx.globalAlpha=1}}const u={canvas:null,ctx:null,cursor:{x:0,y:0,ox:0,oy:0},active:null,block:50,roomName:"",board:[[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null]],start_positions:[[["rook",1],["knight",1],["bishop",1],["queen",1],["king",1],["bishop",1],["knight",1],["rook",1]],[["pawn",1],["pawn",1],["pawn",1],["pawn",1],["pawn",1],["pawn",1],["pawn",1],["pawn",1]],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[["pawn",0],["pawn",0],["pawn",0],["pawn",0],["pawn",0],["pawn",0],["pawn",0],["pawn",0]],[["rook",0],["knight",0],["bishop",0],["queen",0],["king",0],["bishop",0],["knight",0],["rook",0]]],color:null,canMove:!1,conn:null,init(){this.canvas=document.getElementById("canvas"),this.ctx=this.canvas.getContext("2d")},start(){for(let l=0;l<8;l++)for(let t=0;t<8;t++)null!==this.start_positions[l][t]&&(this.board[l][t]=new r(this.start_positions[l][t][0],t,l,this.start_positions[l][t][1]));this.tic()},draw(){this.draw_board(),this.draw_chessmen(),this.draw_tips()},tic(){this.draw()},draw_board:function(){this.ctx.fillStyle="rgb(255, 255, 255)",this.ctx.fillRect(0,0,8*this.block,8*this.block);let l=0;for(let t=0;t<8;t++){for(let e=0;e<8;e++)this.ctx.fillStyle=l%2==-0?"#ceb29c":"#f5e6cf",this.ctx.fillRect(e*this.block,t*this.block,this.block,this.block),l++;l++}},draw_chessmen:function(){for(let l=0;l<8;l++)for(let t=0;t<8;t++)null!==this.board[l][t]&&this.board[l][t].draw()},draw_tips:function(){null!==this.active&&this.board[this.active.v][this.active.h].drawTips()},select(l,t){if(this.canMove&&null!==this.board[l][t]){if(this.board[l][t].color!==this.color)return;this.board[l][t].setActive(),this.active={v:l,h:t}}},move(l,t){if(this.active){if(null!==this.board[this.active.v][this.active.h]){let e=this.board[this.active.v][this.active.h].getSteps();for(let n of e)if(n.h===t&&n.v===l){this.board[this.active.v][this.active.h].go(t,l);let e={h:this.active.h,v:this.active.v},n={h:t,v:l};v.move(e,n),this.canMove=!1,this.active={v:l,h:t}}}this.board[this.active.v][this.active.h].setDisactive(),this.active=null}}},h={run(l){switch(console.log(l),l.action){case"move":console.log("move"),this.move(l.from,l.to);break;case"start":this.start(l.color);break;default:console.error("Event didnt find")}},start(l){document.getElementById("wait").style.display="none",u.color=l,u.canMove=0==l},end(l){},move(l,t){u.board[l.v][l.h].go(t.h,t.v),u.canMove=!0}},v={conn:null,start(){this.conn=new WebSocket("ws://localhost/ws"),this.conn.onclose=function(l){console.warn("Connection closed")},this.conn.onopen=function(l){console.log("Socket connected")},this.conn.onmessage=function(l){let t=JSON.parse(l.data);console.log(l.data),h.run(t)}},joinRoom(l){this.send("join_room",{room_name:l})},createRoom(l){this.send("create_room",{room_name:l})},move(l,t){this.send("move",{from:l,to:t})},send(l,t){let e={action:l,...t},n=JSON.stringify(e);this.conn.send(n)}};console.log("Start"),c.start(),u.init(),t.start(),v.start(),u.start(),setInterval((()=>{u.tic()}),100)})();