(()=>{"use strict";class l{sprite=5;getSteps(l,t,e){let n=[],o=(l?1:-1)+t;0===l&&6===t&&null===v.board[o-1][e]&&n.push({v:o-1,h:e}),1===l&&1===t&&null===v.board[o+1][e]&&n.push({v:o+1,h:e}),null===v.board[o][e]&&n.push({v:o,h:e});for(let t of[-1,1]){let i=e+t;i<0||i>7||null!==v.board[o][i]&&v.board[o][i].color!==l&&n.push({v:o,h:i})}return n}}class t{sprite=3;getSteps(l,t,e){let n=[],o=[{h:2,v:1,a:!0},{h:2,v:-1,a:!0},{h:-2,v:1,a:!0},{h:-2,v:-1,a:!0},{h:1,v:2,a:!0},{h:1,v:-2,a:!0},{h:-1,v:2,a:!0},{h:-1,v:-2,a:!0}];for(let i=1;i<2;i++)for(let s=0;s<8;s++){let a=o[s];if(a.a){let o=e+a.h*i,s=t+a.v*i;if(o>7||o<0)continue;if(s>7||s<0)continue;if(null===v.board[s][o])n.push({v:s,h:o});else{if(void 0===v.board[s][o])continue;v.board[s][o].color!==l&&n.push({v:s,h:o}),a.a=!1}}}return n}}class e{sprite=0;getSteps(l,t,e){let n=[],o=[{h:1,v:1,a:!0},{h:-1,v:-1,a:!0},{h:1,v:-1,a:!0},{h:-1,v:1,a:!0},{h:1,v:0,a:!0},{h:-1,v:0,a:!0},{h:0,v:1,a:!0},{h:0,v:-1,a:!0}];for(let i=1;i<2;i++)for(let s=0;s<8;s++){let a=o[s];if(a.a){let o=e+a.h*i,s=t+a.v*i;if(o>7||o<0)continue;if(s>7||s<0)continue;if(null===v.board[s][o])n.push({v:s,h:o});else{if(void 0===v.board[s][o])continue;v.board[s][o].color!==l&&n.push({v:s,h:o}),a.a=!1}}}return n}}class n{sprite=1;getSteps(l,t,e){let n=[],o=[{h:1,v:1,a:!0},{h:-1,v:-1,a:!0},{h:1,v:-1,a:!0},{h:-1,v:1,a:!0},{h:1,v:0,a:!0},{h:-1,v:0,a:!0},{h:0,v:1,a:!0},{h:0,v:-1,a:!0}];for(let i=1;i<8;i++)for(let s=0;s<8;s++){let a=o[s];if(a.a){let o=e+a.h*i,s=t+a.v*i;if(o>7||o<0)continue;if(s>7||s<0)continue;if(null===v.board[s][o])n.push({v:s,h:o});else{if(void 0===v.board[s][o])continue;v.board[s][o].color!==l&&n.push({v:s,h:o}),a.a=!1}}}return n}}class o{sprite=2;getSteps(l,t,e){let n=[],o=[{h:1,v:1,a:!0},{h:-1,v:-1,a:!0},{h:1,v:-1,a:!0},{h:-1,v:1,a:!0}];for(let i=1;i<8;i++)for(let s=0;s<4;s++){let a=o[s];if(a.a){let o=e+a.h*i,s=t+a.v*i;if(o>7||o<0)continue;if(s>7||s<0)continue;if(null===v.board[s][o])n.push({v:s,h:o});else{if(void 0===v.board[s][o])continue;v.board[s][o].color!==l&&n.push({v:s,h:o}),a.a=!1}}}return n}}class i{sprite=4;getSteps(l,t,e){let n=[],o=[{h:1,v:0,a:!0},{h:-1,v:0,a:!0},{h:0,v:-1,a:!0},{h:0,v:1,a:!0}];for(let i=1;i<8;i++)for(let s=0;s<4;s++){let a=o[s];if(a.a){let o=e+a.h*i,s=t+a.v*i;if(o>7||o<0)continue;if(s>7||s<0)continue;if(null===v.board[s][o])n.push({v:s,h:o});else{if(void 0===v.board[s][o])continue;v.board[s][o].color!==l&&n.push({v:s,h:o}),a.a=!1}}}return n}}class s{color=0;v=0;h=0;piece=null;pieceName="";active=!1;moved=!1;constructor(s,a,h,c){switch(this.h=a,this.v=h,this.color=c,this.pieceName=s,s){case"pawn":this.piece=new l;break;case"knight":this.piece=new t;break;case"king":this.piece=new e;break;case"queen":this.piece=new n;break;case"bishop":this.piece=new o;break;case"rook":this.piece=new i;break;default:console.error("Didn't find piece")}}sprite(){return this.piece.sprite}setActive(){this.active=!0}setDisactive(){this.active=!1}getSteps(){return this.piece.getSteps(this.color,this.v,this.h)}go(l,t){v.board[this.v][this.h]=null,this.h=l,this.v=t,v.board[t][l]=this}}const a={sprites:{chessmen:null},init(){this.sprites.chessmen=new Image,this.sprites.chessmen.src="sprites.png"}},h={canvas:null,ctx:null,colors:{board:{black:"#ceb29c",white:"#f5e6cf",active:"#9cce9d",tip:"#9cc0ce"}},init(){this.canvas=document.getElementById("canvas"),this.ctx=this.canvas.getContext("2d")},draw(l,t,e,n){this.board(l),this.tips(l,t,n),this.chessmen(l,t,e)},board(l){this.ctx.fillStyle="rgb(255, 255, 255)",this.ctx.fillRect(0,0,8*l,8*l);let t=0;for(let e=0;e<8;e++){for(let n=0;n<8;n++)this.ctx.fillStyle=t%2==-0?this.colors.board.black:this.colors.board.white,this.ctx.fillRect(n*l,e*l,l,l),t++;t++}},chessmen(l,t,e){for(let n=0;n<8;n++)for(let o=0;o<8;o++)null!==t[n][o]&&this.piece(t[n][o],l,e)},piece(l,t,e){l.active?(this.ctx.fillStyle=this.colors.board.active,this.ctx.fillRect(l.h*t,l.v*t,t,t),this.ctx.drawImage(a.sprites.chessmen,213*l.sprite(),213*l.color,213,213,e.x-v.block/2,e.y-v.block/2,t,t)):this.ctx.drawImage(a.sprites.chessmen,213*l.sprite(),213*l.color,213,213,l.h*t,l.v*t,t,t)},tips(l,t,e){if(null!==e){let n=t[e.v][e.h].getSteps();for(let t=0;t<n.length;t++)this.ctx.fillStyle=this.colors.board.tip,this.ctx.globalAlpha=.7,this.ctx.fillRect(n[t].h*l,n[t].v*l,l,l),this.ctx.globalAlpha=1}}},c={join(l){document.getElementById("join").style.display=l?"block":"none"},wait(l){document.getElementById("wait").style.display=l?"block":"none"},cursor(l){document.body.style.cursor=l},resize(){let l=.75*Math.min(window.innerWidth,window.innerHeight);h.canvas.width=l,h.canvas.height=l,v.block=l/8}},r={create(l){f.createRoom(l),c.join(!1),c.wait(!0)},join(l){f.joinRoom(l),c.join(!1),c.wait(!0)}},u={cursor:{x:0,y:0,ox:0,oy:0},init(){document.getElementById("createRoom").addEventListener("click",(l=>{r.create(document.getElementById("roomName").value)})),document.getElementById("joinRoom").addEventListener("click",(l=>{r.join(document.getElementById("roomName").value)})),h.canvas.addEventListener("mousedown",(l=>{this.down(l)})),h.canvas.addEventListener("mouseup",(l=>{this.up(l)})),h.canvas.addEventListener("mousemove",(l=>{this.move(l)})),window.addEventListener("resize",(l=>{c.resize()}))},down(l){let t=Math.floor(l.offsetX/v.block),e=Math.floor(l.offsetY/v.block);this.cursor.ox=t*v.block-l.offsetX,this.cursor.oy=e*v.block-l.offsetY,v.select(e,t)},up(l){let t=Math.floor(l.offsetX/v.block),e=Math.floor(l.offsetY/v.block);v.move(e,t)},move(l){this.cursor.x=l.offsetX,this.cursor.y=l.offsetY}},v={active:null,block:100,size:1,board:[[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null]],start_positions:[[["rook",1],["knight",1],["bishop",1],["queen",1],["king",1],["bishop",1],["knight",1],["rook",1]],[["pawn",1],["pawn",1],["pawn",1],["pawn",1],["pawn",1],["pawn",1],["pawn",1],["pawn",1]],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[["pawn",0],["pawn",0],["pawn",0],["pawn",0],["pawn",0],["pawn",0],["pawn",0],["pawn",0]],[["rook",0],["knight",0],["bishop",0],["queen",0],["king",0],["bishop",0],["knight",0],["rook",0]]],color:null,canMove:!1,init(){for(let l=0;l<8;l++)for(let t=0;t<8;t++)null!==this.start_positions[l][t]&&(this.board[l][t]=new s(this.start_positions[l][t][0],t,l,this.start_positions[l][t][1]));this.tic()},tic(){h.draw(this.block,this.board,u.cursor,this.active)},select(l,t){if(this.canMove&&null!==this.board[l][t]){if(this.board[l][t].color!==this.color)return;this.board[l][t].setActive(),this.active={v:l,h:t},c.cursor("grabbing")}},move(l,t){if(this.active){if(null!==this.board[this.active.v][this.active.h]){let e=this.board[this.active.v][this.active.h].getSteps(),n=!1;for(let o of e)o.h===t&&o.v===l&&(n=!0);if(n){let e=this.board[l][t];if(this.board[this.active.v][this.active.h].go(t,l),console.log("MOVE"),this.isCheck(this.color))this.board[l][t].go(this.active.h,this.active.v),this.board[l][t]=e;else{let e={h:this.active.h,v:this.active.v},n={h:t,v:l};f.move(e,n),this.canMove=!1,this.active={v:l,h:t},this.board[l][t]}}}this.board[this.active.v][this.active.h].setDisactive(),this.active=null}c.cursor("default")},isCheck(l){let t=0;console.log(t);let e=null;for(let t=0;t<8;t++)for(let n=0;n<8;n++)null!==this.board[t][n]&&"king"===this.board[t][n].pieceName&&this.board[t][n].color===l&&(e={v:t,h:n});for(let n=0;n<8;n++)for(let o=0;o<7;o++)if(null!==this.board[n][o]){let i=this.board[n][o];if(i.color!==l){t++,console.log(t);let l=i.getSteps();for(let t=0;t<l.length;t++)if(l[t].h===e.h&&l[t].v===e.v)return!0}}return!1}},d={run(l){switch(console.log(l),l.action){case"move":this.move(l.move.from,l.move.to);break;case"start":this.start(l.color);break;default:console.error("Event didnt find")}},start(l){c.wait(!1),v.color=l,v.canMove=0==l},end(l){},move(l,t){v.board[l.v][l.h].go(t.h,t.v),v.canMove=!0}},f={conn:null,init(){this.conn=new WebSocket("ws://localhost/ws"),this.conn.onclose=function(l){console.warn("Connection closed")},this.conn.onopen=function(l){console.log("Socket connected")},this.conn.onmessage=function(l){let t=JSON.parse(l.data);console.log(l.data),d.run(t)}},joinRoom(l){this.send("join_room",{create_room:{room_name:l}})},createRoom(l){this.send("create_room",{join_room:{room_name:l}})},move(l,t){this.send("move",{move:{from:l,to:t}})},send(l,t){let e={action:l,...t},n=JSON.stringify(e);this.conn.send(n)}};a.init(),h.init(),v.init(),u.init(),f.init(),c.resize(),setInterval((()=>{v.tic()}),100)})();